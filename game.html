<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const messageElement = document.getElementById('message');

    const player = { x: 10, y: 10, size: 20, color: 'blue' };
    const truck = { x: 260, y: 440, width: 60, height: 40, color: 'red' };
    const obstacles = [
        { x: 100, y: 200, size: 20, color: 'gray', direction: 1 },
        { x: 150, y: 300, size: 20, color: 'green', direction: -1 },
        { x: 50, y: 100, size: 20, color: 'yellow', direction: 1 },
        { x: 180, y: 80, size: 20, color: 'orange', direction: -1 },
    ];
    const gameState = { score: 0, won: false, collision: false };

    let moveInterval = null;

    function drawPlayer() {
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.size, player.size);
    }

    function drawTruck() {
        ctx.fillStyle = truck.color;
        ctx.fillRect(truck.x, truck.y, truck.width, truck.height);
        ctx.fillStyle = 'black';
        ctx.fillRect(truck.x + 10, truck.y - 10, truck.width - 20, 10);
        ctx.fillStyle = 'white';
        ctx.fillRect(truck.x + 15, truck.y + 10, truck.width - 30, 10);
    }

    function drawObstacles() {
        obstacles.forEach(obstacle => {
            ctx.fillStyle = obstacle.color;
            ctx.fillRect(obstacle.x, obstacle.y, obstacle.size, obstacle.size);
            ctx.beginPath();
            ctx.arc(obstacle.x + obstacle.size / 2, obstacle.y - 10, 10, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function moveObstacles() {
        obstacles.forEach(obstacle => {
            obstacle.x += obstacle.direction * 2;
            if (obstacle.x < 0 || obstacle.x + obstacle.size > canvas.width) {
                obstacle.direction *= -1;
            }
        });
    }

    function detectCollision() {
        for (const obstacle of obstacles) {
            if (
                player.x < obstacle.x + obstacle.size &&
                player.x + player.size > obstacle.x &&
                player.y < obstacle.y + obstacle.size &&
                player.y + player.size > obstacle.y
            ) {
                gameState.collision = true;
                return true;
            }
        }
        return false;
    }

    function detectWin() {
        if (
            player.x < truck.x + truck.width &&
            player.x + player.size > truck.x &&
            player.y < truck.y + truck.height &&
            player.y + player.size > truck.y
        ) {
            gameState.score += 100;
            scoreElement.textContent = `Score: ${gameState.score}`;
            resetPlayer();

            if (gameState.score >= 500) {
                messageElement.textContent = 'YOU ARE HIRED!';
                messageElement.style.color = 'green';
                gameState.won = true;
            }
        }
    }

    function resetPlayer() {
        player.x = 10;
        player.y = 10;
        gameState.collision = false;
        messageElement.textContent = '';
    }

    function updateGame() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawPlayer();
        drawTruck();
        drawObstacles();

        if (gameState.collision) {
            messageElement.textContent = 'MISSION FAILED!';
            messageElement.style.color = 'red';
            setTimeout(() => {
                resetPlayer();
            }, 1000);
        } else {
            detectWin();
        }
    }

    function movePlayer(dx, dy) {
        if (!gameState.won) {
            player.x += dx;
            player.y += dy;

            if (detectCollision()) {
                updateGame();
                return;
            }
            updateGame();
        }
    }

    function startMoving(dx, dy) {
        if (moveInterval === null) {
            moveInterval = setInterval(() => movePlayer(dx, dy), 100);
        }
    }

    function stopMoving() {
        clearInterval(moveInterval);
        moveInterval = null;
    }

    document.getElementById('left').addEventListener('mousedown', () => startMoving(-20, 0));
    document.getElementById('right').addEventListener('mousedown', () => startMoving(20, 0));
    document.getElementById('up').addEventListener('mousedown', () => startMoving(0, -20));
    document.getElementById('down').addEventListener('mousedown', () => startMoving(0, 20));

    document.getElementById('left').addEventListener('mouseup', stopMoving);
    document.getElementById('right').addEventListener('mouseup', stopMoving);
    document.getElementById('up').addEventListener('mouseup', stopMoving);
    document.getElementById('down').addEventListener('mouseup', stopMoving);

    // Add touch event listeners for mobile support
    document.getElementById('left').addEventListener('touchstart', () => startMoving(-20, 0));
    document.getElementById('right').addEventListener('touchstart', () => startMoving(20, 0));
    document.getElementById('up').addEventListener('touchstart', () => startMoving(0, -20));
    document.getElementById('down').addEventListener('touchstart', () => startMoving(0, 20));

    document.getElementById('left').addEventListener('touchend', stopMoving);
    document.getElementById('right').addEventListener('touchend', stopMoving);
    document.getElementById('up').addEventListener('touchend', stopMoving);
    document.getElementById('down').addEventListener('touchend', stopMoving);

    function gameLoop() {
        moveObstacles();
        updateGame();
        requestAnimationFrame(gameLoop);
    }

    gameLoop();
</script>
